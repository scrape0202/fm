<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Database</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #ffffff;
            color: #000000;
            line-height: 1.6;
            padding-top: 60px;
        }

        .sticky-notice {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #000000;
            color: #ffffff;
            padding: 12px 20px;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            z-index: 1000;
            border-bottom: 1px solid #333;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            border-bottom: 1px solid #000000;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 600;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1px;
            background: #000000;
            border: 1px solid #000000;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: #ffffff;
            padding: 15px;
        }
        
        .stat-card .value {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .stat-card .label {
            color: #666666;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .search-box {
            flex: 2;
            min-width: 250px;
            padding: 12px;
            border: 1px solid #000000;
            font-size: 14px;
        }
        
        .select-box {
            flex: 1;
            min-width: 120px;
            padding: 10px;
            border: 1px solid #000000;
            background: white;
        }
        
        .btn {
            padding: 12px 20px;
            border: 1px solid #000000;
            background: #000000;
            color: #ffffff;
            font-size: 14px;
            cursor: pointer;
        }
        
        .btn.secondary {
            background: #ffffff;
            color: #000000;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 4px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .page-btn {
            padding: 6px 10px;
            border: 1px solid #000000;
            background: #fff;
            cursor: pointer;
            font-size: 12px;
            min-width: 35px;
        }

        .page-btn.active {
            background: #000000;
            color: #fff;
        }

        .table-container {
            border: 1px solid #000000;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }
        
        th {
            background: #000000;
            color: #ffffff;
            padding: 12px;
            text-align: left;
            font-size: 11px;
            text-transform: uppercase;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }
        
        th.sorted-asc::after { content: ' ↑'; }
        th.sorted-desc::after { content: ' ↓'; }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #e5e5e5;
            font-size: 13px;
        }

        .profile-link {
            text-decoration: none;
            color: inherit;
            transition: color 0.2s;
            cursor: pointer;
        }

        .profile-link:hover {
            color: #007bff;
        }
        
        .flag-icon {
            width: 18px;
            height: 12px;
            margin-right: 6px;
            vertical-align: middle;
            border: 1px solid #f0f0f0;
        }
        
        .truncate {
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @media (max-width: 768px) {
            body { padding-top: 80px; }
            .sticky-notice { font-size: 11px; padding: 10px; }
            .container { padding: 10px; }
            .header h1 { font-size: 24px; }
            .controls { flex-direction: column; }
            .search-box, .select-box, .btn { width: 100%; }
        }

        .loading { text-align: center; padding: 40px; }
        .spinner {
            border: 2px solid #e5e5e5;
            border-top: 2px solid #000000;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="sticky-notice">
        I've noticed searching up "Discord" or "Snap" has shown users to have games relating to that (saying they have that social) which helps you show whos a weirdo
    </div>

    <div class="container">
        <div class="header">
            <h1>User Database</h1>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="value" id="totalCount">0</div>
                <div class="label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="value" id="displayedCount">0</div>
                <div class="label">Filtered</div>
            </div>
            <div class="stat-card">
                <div class="value" id="highScoreCount">0</div>
                <div class="label">Score > 1,000</div>
            </div>
            <div class="stat-card">
                <div class="value" id="topRegion">--</div>
                <div class="label">Top Region</div>
            </div>
        </div>

        <div class="controls">
            <input type="text" id="searchBox" class="search-box" placeholder="Search name, ID, region, interests...">
            <div style="display:flex; gap:10px; flex: 1;">
                <select id="pageSize" class="select-box" onchange="changePageSize()">
                    <option value="25">25 / page</option>
                    <option value="50">50 / page</option>
                    <option value="100" selected>100 / page</option>
                    <option value="500">500 / page</option>
                    <option value="1000">1000 / page</option>
                </select>
                <button class="btn" onclick="loadAllData(true)">Refresh</button>
            </div>
            <button class="btn secondary" onclick="exportCSV()">Export CSV</button>
        </div>

        <div id="paginationTop" class="pagination"></div>

        <div class="table-container">
            <div id="loading" class="loading">
                <div class="spinner"></div>
            </div>
            <table id="userTable" style="display: none;">
                <thead>
                    <tr>
                        <th class="sortable" data-column="display_name">Name</th>
                        <th class="sortable" data-column="username">User</th>
                        <th class="sortable" data-column="user_id">ID</th>
                        <th class="sortable" data-column="region">Region</th>
                        <th class="sortable" data-column="score">Score</th>
                        <th class="sortable" data-column="friends">Friends</th>
                        <th class="sortable" data-column="donated">Donated</th>
                        <th class="sortable" data-column="received">Received</th>
                        <th class="sortable" data-column="interests">Interests</th>
                        <th class="sortable" data-column="favorites">Favorites</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <div id="paginationBottom" class="pagination"></div>
    </div>

    <script>
        const SUPABASE_URL = "https://qivhtheytfxhvsdybnru.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpdmh0aGV5dGZ4aHZzZHlibnJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNjA1NTIsImV4cCI6MjA4NTYzNjU1Mn0.XHmeniPie7Jvsr0dokb0rFGJ0o1r80iZlSr7PYhK10A";
        
        let allUsers = [];
        let filteredUsers = [];
        let currentPage = 1;
        let pageSize = 100;
        let lastUserCount = 0;
        let currentSort = { column: 'created_at', direction: 'desc' };

        async function loadAllData(force = false) {
            try {
                const countRes = await fetch(`${SUPABASE_URL}/rest/v1/users?select=count`, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Prefer': 'count=exact' }
                });
                const totalCount = parseInt(countRes.headers.get('content-range').split('/')[1]);

                if (!force && totalCount === lastUserCount) return;
                lastUserCount = totalCount;

                let fetched = [];
                let offset = 0;
                const limit = 1000;
                let hasMore = true;

                while (hasMore) {
                    const response = await fetch(
                        `${SUPABASE_URL}/rest/v1/users?select=*&order=created_at.desc&limit=${limit}&offset=${offset}`,
                        { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                    );
                    const batch = await response.json();
                    fetched = fetched.concat(batch);
                    if (batch.length < limit) hasMore = false;
                    else offset += limit;
                }

                allUsers = fetched;
                applySearchAndSort();
                updateStats();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('userTable').style.display = 'table';
            } catch (error) {
                console.error(error);
            }
        }

        function applySearchAndSort() {
            const query = document.getElementById('searchBox').value.toLowerCase();
            
            filteredUsers = allUsers.filter(user => 
                (user.display_name || '').toLowerCase().includes(query) ||
                (user.username || '').toLowerCase().includes(query) ||
                (user.user_id || '').toLowerCase().includes(query) ||
                (user.region || '').toLowerCase().includes(query) ||
                (user.interests || '').toLowerCase().includes(query) ||
                (user.favorites || '').toLowerCase().includes(query)
            );

            filteredUsers.sort((a, b) => {
                let valA = a[currentSort.column];
                let valB = b[currentSort.column];
                
                if (typeof valA === 'string') {
                    valA = (valA || '').toLowerCase();
                    valB = (valB || '').toLowerCase();
                    return currentSort.direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                } else {
                    valA = valA || 0;
                    valB = valB || 0;
                    return currentSort.direction === 'asc' ? valA - valB : valB - valA;
                }
            });

            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            const start = (currentPage - 1) * pageSize;
            const pageData = filteredUsers.slice(start, start + pageSize);

            pageData.forEach(user => {
                const row = tbody.insertRow();
                const rc = (user.region || '').toLowerCase();
                const flag = rc && rc.length === 2 ? `<img src="https://flagcdn.com/w40/${rc}.png" class="flag-icon">` : '';
                const profileUrl = `https://www.roblox.com/users/${user.user_id}/profile`;

                row.innerHTML = `
                    <td><a href="${profileUrl}" target="_blank" class="profile-link">${user.display_name || '-'}</a></td>
                    <td><a href="${profileUrl}" target="_blank" class="profile-link">@${user.username || '-'}</a></td>
                    <td>${user.user_id}</td>
                    <td>${flag}${user.region || '??'}</td>
                    <td><b>${(user.score || 0).toLocaleString()}</b></td>
                    <td>${(user.friends || 0).toLocaleString()}</td>
                    <td>${(user.donated || 0).toLocaleString()}</td>
                    <td>${(user.received || 0).toLocaleString()}</td>
                    <td class="truncate" title="${user.interests || ''}">${user.interests || '-'}</td>
                    <td class="truncate" title="${user.favorites || ''}">${user.favorites || '-'}</td>
                `;
            });

            document.getElementById('displayedCount').textContent = filteredUsers.length.toLocaleString();
            renderPagination();
        }

        function renderPagination() {
            const totalPages = Math.ceil(filteredUsers.length / pageSize);
            const containers = [document.getElementById('paginationTop'), document.getElementById('paginationBottom')];
            
            containers.forEach(container => {
                container.innerHTML = '';
                if (totalPages <= 1) return;

                const addBtn = (p, label = p, active = false) => {
                    const btn = document.createElement('button');
                    btn.className = `page-btn ${active ? 'active' : ''}`;
                    btn.textContent = label;
                    btn.onclick = () => { currentPage = p; renderTable(); window.scrollTo(0,0); };
                    container.appendChild(btn);
                };

                addBtn(1, '«');
                
                let start = Math.max(1, currentPage - 2);
                let end = Math.min(totalPages, currentPage + 2);

                if (start > 1) {
                    addBtn(1);
                    if (start > 2) { const s = document.createElement('span'); s.textContent = '...'; container.appendChild(s); }
                }

                for (let i = start; i <= end; i++) addBtn(i, i, i === currentPage);

                if (end < totalPages) {
                    if (end < totalPages - 1) { const s = document.createElement('span'); s.textContent = '...'; container.appendChild(s); }
                    addBtn(totalPages);
                }

                addBtn(totalPages, '»');
            });
        }

        function updateStats() {
            document.getElementById('totalCount').textContent = allUsers.length.toLocaleString();
            document.getElementById('highScoreCount').textContent = allUsers.filter(u => (u.score || 0) > 1000).length.toLocaleString();
            const counts = {};
            allUsers.forEach(u => { const r = u.region || 'Unknown'; counts[r] = (counts[r] || 0) + 1; });
            const top = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b, '--');
            document.getElementById('topRegion').textContent = top;
        }

        function changePageSize() {
            pageSize = parseInt(document.getElementById('pageSize').value);
            currentPage = 1;
            renderTable();
        }

        document.getElementById('searchBox').addEventListener('input', () => {
            currentPage = 1;
            applySearchAndSort();
        });

        document.querySelectorAll('th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const col = th.dataset.column;
                currentSort.direction = (currentSort.column === col && currentSort.direction === 'asc') ? 'desc' : 'asc';
                currentSort.column = col;
                document.querySelectorAll('th').forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
                th.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
                applySearchAndSort();
            });
        });

        function exportCSV() {
            const cols = ['Name', 'User', 'ID', 'Region', 'Score', 'Friends', 'Donated', 'Received', 'Interests', 'Favorites'];
            const csv = [cols.join(','), ...filteredUsers.map(u => [
                u.display_name, u.username, u.user_id, u.region, u.score, u.friends, u.donated, u.received, `"${u.interests||''}"`, `"${u.favorites||''}"`
            ].join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `export.csv`;
            a.click();
        }

        setInterval(loadAllData, 15000);
        loadAllData();
    </script>
</body>
</html>
